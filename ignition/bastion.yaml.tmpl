systemd:
  units:
    - name: update-engine.service
      enabled: false
      mask: true
    - name: locksmithd.service
      enabled: false
      mask: true
    - name: etcd2.service
      enabled: false
      mask: true
    - name: etcd-init.service
      command: stop
      enabled: false
      mask: true
    - name: fleet.service
      enabled: false
      mask: true
    - name: os-hardening.service
      enabled: true
      contents: |
        [Unit]
        Description=Apply os hardening
        [Service]
        Type=oneshot
        ExecStart=-/bin/bash -c "gpasswd -d core rkt; gpasswd -d core docker; gpasswd -d core wheel"
        [Install]
        WantedBy=multi-user.target
    - name: get-vault-ssh-ca.service
      enabled: true
      contents: |
        [Unit]
        Description=get-vault-ssh-ca
        Requires=docker.service
        After=docker.service

        [Service]
        EnvironmentFile=/etc/tokens/node
        Environment=VAULT_ADDR=https://${VAULT_DOMAIN_NAME}:443
        Environment=IMAGE=vault:0.10.0
        Type=oneshot
        RemainAfterExit=yes
        ExecStartPre=/usr/bin/docker pull $IMAGE
        ExecStart=/bin/bash -c '\
               result=$(docker run --rm -i\
               -v /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt\
               -v /etc/ssh/:/etc/ssh/\
               --net host\
               --privileged=true\
               -e VAULT_ADDR\
               -e VAULT_TOKEN\
               $IMAGE\
               read -field=public_key ssh-client-signer/config/ca > /etc/ssh/trusted-user-ca-keys.pem);\
           [ $? -ne 0 ] && echo "Failed to fetch CA ssh public key" && exit 1 || echo "Sucesfully retrieved CA ssh public key";'
        [Install]
        WantedBy=multi-user.target
storage:
  files:
    - path: /etc/ssh/sshd_config
      filesystem: root
      mode: 0600
      contents:
        inline: |
          # Use most defaults for sshd configuration.
          UsePrivilegeSeparation sandbox
          Subsystem sftp internal-sftp
          ClientAliveInterval 180
          UseDNS no
          UsePAM yes
          PrintLastLog no # handled by PAM
          PrintMotd no # handled by PAM
          # Non defaults
          ClientAliveCountMax 2
          PasswordAuthentication no
          TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem
